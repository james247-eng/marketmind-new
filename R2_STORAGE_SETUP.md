# üì¶ Cloudflare R2 Storage Setup Guide

## What is R2?

Cloudflare R2 is an **object storage service** (like AWS S3) for storing files generated by your app:

- User-uploaded files
- AI-generated images and documents
- Content exports and backups

## Quick Setup (5 minutes)

### Step 1: Create R2 Bucket

1. Go to **[Cloudflare Dashboard](https://dash.cloudflare.com)**
2. Left menu ‚Üí **R2**
3. Click **"Create bucket"**
4. **Bucket name:** `marketmind-content`
5. **Region:** Automatic (default)
6. Click **"Create"**

### Step 2: Create API Token

1. Still in R2 section
2. Click the bucket you just created
3. Go to **Settings** tab
4. Scroll down to **API Tokens**
5. Click **"Create API Token"**
6. Configure:
   - **Token name:** `MarketMind Token`
   - **Permissions:** `Edit` (allows uploads and deletions)
   - **TTL:** No expiration (or set 1 year)
7. Click **"Create"**
8. **Copy these 3 values somewhere safe:**
   - `Access Key ID` ‚Üí Paste in .env.local as `R2_ACCESS_KEY_ID`
   - `Secret Access Key` ‚Üí Paste in .env.local as `R2_SECRET_ACCESS_KEY`

### Step 3: Get Account ID

1. In the Cloudflare Dashboard, go to **R2**
2. Click your bucket name
3. Go to **Settings**
4. Look for **Account ID** or **Bucket details**
5. Copy the Account ID
6. Paste in .env.local as `VITE_R2_ACCOUNT_ID`

### Step 4: Update .env.local

Open `.env.local` and fill in the R2 section:

```env
# Cloudflare R2 Storage
VITE_R2_ACCOUNT_ID=your_cloudflare_account_id
R2_BUCKET_NAME=marketmind-content
R2_ACCESS_KEY_ID=your_r2_access_key_id
R2_SECRET_ACCESS_KEY=your_r2_secret_access_key
```

**Example (DO NOT USE - for reference only):**

```env
VITE_R2_ACCOUNT_ID=a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6
R2_BUCKET_NAME=marketmind-content
R2_ACCESS_KEY_ID=AKIAIOSFODNN7EXAMPLE
R2_SECRET_ACCESS_KEY=wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY
```

### Step 5: Update Netlify Environment Variables

1. Go to **[Netlify](https://app.netlify.com)**
2. Select your site
3. **Settings** ‚Üí **Build & Deploy** ‚Üí **Environment**
4. Add these variables:

| Variable               | Value                | Type   |
| ---------------------- | -------------------- | ------ |
| `VITE_R2_ACCOUNT_ID`   | Your account ID      | Public |
| `R2_BUCKET_NAME`       | `marketmind-content` | Public |
| `R2_ACCESS_KEY_ID`     | Your access key      | Secret |
| `R2_SECRET_ACCESS_KEY` | Your secret key      | Secret |

‚ö†Ô∏è **IMPORTANT:** Mark the last two as "Secret" so they don't appear in logs.

## Environment Variable Breakdown

| Variable               | Public? | Where Used         | Purpose                       |
| ---------------------- | ------- | ------------------ | ----------------------------- |
| `VITE_R2_ACCOUNT_ID`   | ‚úÖ Yes  | Frontend + Backend | Account identifier for R2 URL |
| `R2_BUCKET_NAME`       | ‚úÖ Yes  | Backend            | Which bucket to upload to     |
| `R2_ACCESS_KEY_ID`     | ‚ùå No   | Backend Only       | Authentication credential     |
| `R2_SECRET_ACCESS_KEY` | ‚ùå No   | Backend Only       | Authentication secret         |

## How It Works in Your App

```
User generates content on Dashboard
    ‚Üì
Cloud Function calls Gemini API
    ‚Üì
AI generates text/image/PDF
    ‚Üì
Cloud Function uploads to R2 bucket using credentials
    ‚Üì
R2 generates public URL
    ‚Üì
User downloads file from R2 public URL
```

## Testing R2 Setup

### For Local Development

1. Make sure `.env.local` has R2 credentials filled in
2. Run: `npm run dev`
3. Go to `/dashboard` ‚Üí **Generate Content**
4. Create a piece of content
5. Check Cloudflare R2 bucket ‚Üí Your bucket ‚Üí Should see file

### For Netlify Deployment

1. Add R2 environment variables to Netlify (see Step 5 above)
2. Trigger deploy: **Site Settings** ‚Üí **Trigger Deploy**
3. Wait for deploy to complete
4. Test content generation on live site
5. Check R2 bucket for new files

## Troubleshooting

### "R2 upload failed" error

**Problem:** Variables not set in Netlify environment

**Solution:**

1. Go to Netlify ‚Üí Site Settings ‚Üí Environment
2. Verify all 4 R2 variables are present
3. Trigger deploy to apply changes

### "Invalid credentials"

**Problem:** Access Key ID or Secret is wrong

**Solution:**

1. Go to Cloudflare R2 ‚Üí Settings ‚Üí API Tokens
2. Delete old token
3. Create new token
4. Copy new credentials to Netlify environment

### "Bucket not found"

**Problem:** Bucket name is wrong

**Solution:**

1. In Cloudflare R2, verify exact bucket name
2. Update `R2_BUCKET_NAME` in both .env.local and Netlify
3. Make sure it matches exactly (case-sensitive)

### Files show in R2 but can't download

**Problem:** Bucket permissions are wrong

**Solution:**

1. Go to R2 bucket ‚Üí **Settings**
2. Scroll to **CORS** section
3. Add:
   ```
   Allowed origins: https://marketmind-02.netlify.app
   Allowed methods: GET, PUT
   Allowed headers: *
   ```

## Security Notes

- ‚úÖ `VITE_R2_ACCOUNT_ID` is safe to expose (it's public information)
- ‚úÖ `R2_BUCKET_NAME` is safe to expose (just a name)
- ‚ùå `R2_ACCESS_KEY_ID` must be kept secret (like a password)
- ‚ùå `R2_SECRET_ACCESS_KEY` must be kept secret (like a password)
- ‚úÖ Store secrets in Netlify environment (they're encrypted)
- ‚úÖ Never commit credentials to Git
- ‚úÖ Rotate API tokens every 90 days in production

## Next Steps

1. ‚úÖ Create R2 bucket
2. ‚úÖ Create API token
3. ‚úÖ Get Account ID
4. ‚úÖ Update `.env.local`
5. ‚úÖ Update Netlify environment
6. ‚úÖ Test with local `npm run dev`
7. ‚úÖ Trigger Netlify deploy and test live
8. ‚úÖ Monitor uploads in R2 dashboard

## Resources

- [Cloudflare R2 Docs](https://developers.cloudflare.com/r2/)
- [R2 API Reference](https://developers.cloudflare.com/r2/api/)
- [Cloudflare Support](https://support.cloudflare.com/)
